name: Nightly Ingredient Queue

on:
  workflow_call:
    inputs:
      queue_batch_limit:
        description: "Queue batch size"
        required: false
        type: string
        default: "100"
      queue_context:
        description: "Standardizer context"
        required: false
        type: string
        default: "pantry"
      queue_resolver_name:
        description: "Resolver run name"
        required: false
        type: string
        default: "nightly-openai"
      queue_dry_run:
        description: "true/false dry run"
        required: false
        type: string
        default: "false"
      openai_model:
        description: "OpenAI model"
        required: false
        type: string
        default: "gpt-4o-mini"
      gemini_model:
        description: "Gemini model"
        required: false
        type: string
        default: "gemini-3-flash-preview"
  workflow_dispatch:
    inputs:
      queue_batch_limit:
        description: "Queue batch size"
        required: false
        type: string
        default: "100"
      queue_context:
        description: "Standardizer context"
        required: false
        type: choice
        options:
          - pantry
          - recipe
        default: pantry
      queue_resolver_name:
        description: "Resolver run name"
        required: false
        type: string
        default: "nightly-openai"
      queue_dry_run:
        description: "Dry run mode"
        required: false
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
      openai_model:
        description: "OpenAI model"
        required: false
        type: string
        default: "gpt-4o-mini"
      gemini_model:
        description: "Gemini model"
        required: false
        type: string
        default: "gemini-3-flash-preview"

jobs:
  resolve-ingredient-match-queue:
    name: Resolve Ingredient Match Queue
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Resolve pending ingredient matches
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ inputs.openai_model }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ inputs.gemini_model }}
          QUEUE_BATCH_LIMIT: ${{ inputs.queue_batch_limit }}
          QUEUE_STANDARDIZER_CONTEXT: ${{ inputs.queue_context }}
          QUEUE_RESOLVER_NAME: ${{ inputs.queue_resolver_name }}
          DRY_RUN: ${{ inputs.queue_dry_run }}
          NODE_ENV: production
        run: npm run resolve-ingredient-match-queue
