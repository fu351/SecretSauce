name: Fix Missing Geography
on:
  workflow_dispatch:
    inputs:
      brands:
        description: "Comma- or space-separated store_enum values to target (optional). Leave empty to process all brands in parallel batches."
        required: false
      max_spiders:
        description: "Maximum number of spiders/brands to process per job (optional, default: 2)"
        required: false
        default: "2"

jobs:
  fix-geo:
    name: Fix Missing Geography (Manual)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests supabase ijson

      - name: Run Geo Fixer (Manual)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          BRAND_FILTER: ${{ github.event.inputs.brands }}
          MAX_SPIDERS_PER_RUN: ${{ github.event.inputs.max_spiders }}
        run: python scripts/fix_missing_geo.py
        continue-on-error: false
