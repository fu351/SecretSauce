name: Import New Stores
on:
  workflow_dispatch:
    inputs:
      brands:
        description: "Comma- or space-separated store_enum values to target (optional). Leave empty to process all brands in parallel batches."
        required: false
      max_spiders:
        description: "Maximum number of spiders/brands to process per job (optional, default: 2)"
        required: false
        default: "2"

jobs:
  import-stores:
    name: Import Stores (Manual)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests supabase ijson

      - name: Update Target ZIP Codes
        # Refresh the list of ZIP codes to scrape based on user locations
        # Automatically adds neighboring ZIP codes (±5 from each user ZIP)
        # e.g., user in 94102 → also scrapes 94097-94101, 94103-94107
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python scripts/update_target_zipcodes.py --neighbor-radius 5
        continue-on-error: true # Don't fail if this step fails

      - name: Import Stores (Manual)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          BRAND_FILTER: ${{ github.event.inputs.brands }}
          MAX_SPIDERS_PER_RUN: ${{ github.event.inputs.max_spiders }}
        run: python scripts/import_new_stores.py
        continue-on-error: false
