name: Relink Ingredient Mappings

on:
  schedule:
    # Weekly on Sunday at 3am UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      wipe_queue:
        description: 'Wipe ingredient_match_queue before relinking'
        required: false
        type: boolean
        default: false
      reset_all:
        description: 'Reset ALL mappings (ignore age filter)'
        required: false
        type: boolean
        default: false
      run_recipe_relink:
        description: 'Run recipe ingredient relink step'
        required: false
        type: boolean
        default: true
      run_product_relink:
        description: 'Run product mapping relink step'
        required: false
        type: boolean
        default: true
      run_initiating_workflow:
        description: 'Run full initiating workflow after relink'
        required: false
        type: boolean
        default: false

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  relink:
    runs-on: ubuntu-latest
    steps:
      - name: Wipe Ingredient Match Queue
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.wipe_queue }}
        run: |
          echo "=== Wiping Ingredient Match Queue ==="

          # Get count before wipe
          BEFORE=$(curl -sI \
            "${SUPABASE_URL}/rest/v1/ingredient_match_queue?select=id" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Prefer: count=exact" \
            -H "Range: 0-0" \
            | grep -i '^content-range' \
            | sed -E 's/.*\/([0-9]+).*/\1/' || echo "0")

          echo "Rows before wipe: ${BEFORE}"

          # Delete all rows from ingredient_match_queue
          curl -sf -X DELETE \
            "${SUPABASE_URL}/rest/v1/ingredient_match_queue?id=gt.0" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Prefer: return=minimal"

          # Get count after wipe
          AFTER=$(curl -sI \
            "${SUPABASE_URL}/rest/v1/ingredient_match_queue?select=id" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Prefer: count=exact" \
            -H "Range: 0-0" \
            | grep -i '^content-range' \
            | sed -E 's/.*\/([0-9]+).*/\1/' || echo "0")

          echo "Rows after wipe: ${AFTER}"
          echo "Deleted: $((BEFORE - AFTER)) rows"

      - name: Relink Recipe Ingredients
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_recipe_relink }}
        run: |
          echo "=== Relinking Recipe Ingredients ==="
          RESULT=$(curl -sf -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/fn_relink_recipe_ingredients" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')

          TOTAL=$(echo "$RESULT" | jq 'length')
          CHANGED=$(echo "$RESULT" | jq '[.[] | select(.changed == true)] | length')
          QUEUED=$(echo "$RESULT" | jq '[.[] | select(.ri_match_strategy == "unmatched")] | length')
          echo "Total: ${TOTAL} | Relinked: ${CHANGED} | Queued for LLM: ${QUEUED}"

      - name: Relink Product Mappings
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_product_relink }}
        run: |
          if [ "${{ inputs.reset_all }}" = "true" ]; then
            BODY='{"p_reset_all": true}'
          else
            BODY='{"p_older_than": "1 month"}'
          fi

          echo "=== Relinking Product Mappings ==="
          RESULT=$(curl -sf -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/fn_relink_product_mappings" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          TOTAL=$(echo "$RESULT" | jq 'length')
          CHANGED=$(echo "$RESULT" | jq '[.[] | select(.changed == true)] | length')
          echo "Total: ${TOTAL} | Relinked: ${CHANGED}"

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Resolve Ingredient Match Queue
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_SERVICE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: 'gpt-4o-mini'
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: 'gemini-3-flash-preview'
          QUEUE_STANDARDIZER_CONTEXT: 'pantry'
          QUEUE_RESOLVER_NAME: 'relink-map-run'
          NODE_ENV: production
        run: npm run resolve-ingredient-match-queue

      - name: Queue Summary
        run: |
          echo "=== Queue Status ==="

          # Optimized: Use count queries with minimal data fetch
          get_count() {
            local filter="$1"
            curl -sI \
              "${SUPABASE_URL}/rest/v1/ingredient_match_queue?select=id&${filter}" \
              -H "apikey: ${SUPABASE_SERVICE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
              -H "Prefer: count=exact" \
              -H "Range: 0-0" \
              | grep -i '^content-range' \
              | sed -E 's/.*\/([0-9]+).*/\1/' || echo "0"
          }

          echo "Status breakdown by source:"
          for source in scraper recipe; do
            for status in pending processing success failed; do
              count=$(get_count "source=eq.${source}&status=eq.${status}")
              [ "$count" != "0" ] && echo "  ${source}/${status}: ${count}"
            done
          done

          # Total pending count
          pending_total=$(get_count "status=eq.pending")
          echo "Total pending rows: ${pending_total}"

  initiating-bootstrap:
    name: Full Bootstrap (Initiating Workflow)
    needs: relink
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_initiating_workflow }}
    uses: ./.github/workflows/initiating-workflow.yml
    secrets: inherit
    with:
      queue_resolver_name: "relink-initiating"
      scraper_cities_csv: "San Francisco,Oakland,Berkeley"
      scraper_state: "CA"
      ingredient_limit: "0"
      store_limit: "0"
      queue_batch_limit: "100"
      queue_max_batches: "10"
