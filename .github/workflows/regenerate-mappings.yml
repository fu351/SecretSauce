name: Relink Ingredient Mappings

on:
  schedule:
    # Weekly on Sunday at 3am UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      reset_all:
        description: 'Reset ALL mappings (ignore age filter)'
        required: false
        type: boolean
        default: false

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  relink:
    runs-on: ubuntu-latest
    steps:
      - name: Relink Recipe Ingredients
        run: |
          echo "=== Relinking Recipe Ingredients ==="
          RESULT=$(curl -sf -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/fn_relink_recipe_ingredients" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')

          TOTAL=$(echo "$RESULT" | jq 'length')
          CHANGED=$(echo "$RESULT" | jq '[.[] | select(.changed == true)] | length')
          QUEUED=$(echo "$RESULT" | jq '[.[] | select(.ri_match_strategy == "unmatched")] | length')
          echo "Total: ${TOTAL} | Relinked: ${CHANGED} | Queued for LLM: ${QUEUED}"

      - name: Relink Product Mappings
        run: |
          if [ "${{ inputs.reset_all }}" = "true" ]; then
            BODY='{"p_reset_all": true}'
          else
            BODY='{"p_older_than": "1 month"}'
          fi

          echo "=== Relinking Product Mappings ==="
          RESULT=$(curl -sf -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/fn_relink_product_mappings" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          TOTAL=$(echo "$RESULT" | jq 'length')
          CHANGED=$(echo "$RESULT" | jq '[.[] | select(.changed == true)] | length')
          echo "Total: ${TOTAL} | Relinked: ${CHANGED}"

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Resolve Ingredient Match Queue
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_SERVICE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: 'gpt-4o-mini'
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: 'gemini-3-flash-preview'
          QUEUE_STANDARDIZER_CONTEXT: 'pantry'
          QUEUE_RESOLVER_NAME: 'relink-map-run'
          NODE_ENV: production
        run: npm run resolve-ingredient-match-queue

      - name: Queue Summary
        run: |
          echo "=== Queue Status ==="
          RESULT=$(curl -sf \
            "${SUPABASE_URL}/rest/v1/ingredient_match_queue?select=source,status&limit=10000" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}")

          echo "$RESULT" | jq 'group_by(.source, .status) | map({source: .[0].source, status: .[0].status, count: length})'
