name: Temporary Database Janitor

on:
  schedule:
    # Runs at 3:55 AM PST (11:55 AM UTC)
    - cron: '55 11 * * *' 
  workflow_dispatch: # Allows you to click "Run Workflow" manually

jobs:
  truncate-recent:
    name: Wipe Recent Table
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase client (isolated)
        run: |
          mkdir -p /tmp/supabase-client
          npm install --no-save --no-package-lock --legacy-peer-deps --prefix /tmp/supabase-client @supabase/supabase-js

      - name: Wipe ingredients_recent via Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node - <<'NODE'
          const { createClient } = require('/tmp/supabase-client/node_modules/@supabase/supabase-js')

          const supabaseUrl = process.env.SUPABASE_URL
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY

          if (!supabaseUrl || !supabaseKey) {
            console.error("âŒ Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY")
            process.exit(1)
          }

          const supabase = createClient(supabaseUrl, supabaseKey)

          async function wipeRecent() {
            console.log("ðŸ§¹ Attempting to wipe ingredients_recent...")

            // Delete all rows; the dummy UUID protects against accidental full-table delete guardrails
            const { error } = await supabase
              .from('ingredients_recent')
              .delete()
              .neq('id', '00000000-0000-0000-0000-000000000000')

            if (error) {
              console.error("âŒ Error wiping table:", error)
              process.exit(1)
            }

            console.log("âœ… ingredients_recent table is now empty.")
          }

          wipeRecent()
          NODE
