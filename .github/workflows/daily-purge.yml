name: Daily Purge

on:
  workflow_call:
    inputs:
      purge_mode:
        description: "execute or dry-run"
        required: false
        type: string
        default: "execute"
  workflow_dispatch:
    inputs:
      purge_mode:
        description: "Choose execute to wipe table or dry-run to preview only"
        required: false
        type: choice
        options:
          - execute
          - dry-run
        default: execute

jobs:
  truncate-recent:
    name: Wipe Recent Table
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package-lock.json

      - name: Install Supabase client (isolated)
        run: |
          mkdir -p /tmp/supabase-client
          npm install --no-save --no-package-lock --legacy-peer-deps --prefix /tmp/supabase-client @supabase/supabase-js

      - name: Wipe ingredients_recent via Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PURGE_MODE: ${{ inputs.purge_mode || github.event.inputs.purge_mode || 'execute' }}
        run: |
          node - <<'NODE'
          const { createClient } = require('/tmp/supabase-client/node_modules/@supabase/supabase-js')

          const supabaseUrl = process.env.SUPABASE_URL
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY
          const purgeMode = String(process.env.PURGE_MODE || "execute").toLowerCase()

          if (!supabaseUrl || !supabaseKey) {
            console.error("âŒ Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY")
            process.exit(1)
          }

          const supabase = createClient(supabaseUrl, supabaseKey)

          async function wipeRecent() {
            const isDryRun = purgeMode !== "execute"

            const { count, error: countError } = await supabase
              .from('ingredients_recent')
              .select('*', { head: true, count: 'exact' })

            if (countError) {
              console.error("âŒ Error counting rows:", countError)
              process.exit(1)
            }

            if (isDryRun) {
              console.log(`ðŸ§ª DRY RUN: would delete approximately ${count ?? 0} rows from ingredients_recent`)
              return
            }

            console.log("ðŸ§¹ Attempting to wipe ingredients_recent...")

            // Delete all rows; the dummy UUID protects against accidental full-table delete guardrails
            const { error } = await supabase
              .from('ingredients_recent')
              .delete()
              .neq('id', '00000000-0000-0000-0000-000000000000')

            if (error) {
              console.error("âŒ Error wiping table:", error)
              process.exit(1)
            }

            console.log(`âœ… ingredients_recent table is now empty (deleted approximately ${count ?? 0} rows).`)
          }

          wipeRecent()
          NODE
