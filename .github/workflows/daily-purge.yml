name: Temporary Database Janitor

on:
  schedule:
    # Runs at 3:55 AM PST (11:55 AM UTC)
    - cron: '55 11 * * *' 
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

jobs:
  truncate-recent:
    name: Wipe Recent Table
    runs-on: ubuntu-latest
    steps:
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Truncate Table
        env:
          # This must be the full connection string: postgresql://user:pass@host:5432/dbname
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ§¹ Performing scheduled wipe of ingredients_recent..."
          
          # Pass the DB_URL variable directly as the first argument to psql
          # RESTART IDENTITY resets any auto-incrementing counters
          # CASCADE ensures it runs even if there are complicated dependencies
          psql "$DB_URL" -v ON_ERROR_STOP=1 -c "TRUNCATE TABLE public.ingredients_recent RESTART IDENTITY CASCADE;"
          
          echo "âœ… Table is now empty and ready for the next batch."

      - name: Health Check
        if: success()
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Checking row count..."
          psql "$DB_URL" -c "SELECT count(*) FROM public.ingredients_recent;"