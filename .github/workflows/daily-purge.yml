name: Temporary Database Janitor

on:
  schedule:
    # Runs at 3:55 AM PST (11:55 AM UTC)
    - cron: '55 11 * * *' 
  workflow_dispatch: # Allows you to click "Run Workflow" manually

jobs:
  truncate-recent:
    name: Wipe Recent Table
    runs-on: ubuntu-latest
    
    steps:
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Truncate Table
        env:
          # This must be the "Connection String" from Supabase Settings -> Database
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ§¹ Connecting to Supabase to wipe ingredients_recent..."
          
          # CRITICAL: "$DB_URL" must come BEFORE the -c flag
          psql "$DB_URL" -v ON_ERROR_STOP=1 -c "TRUNCATE TABLE public.ingredients_recent RESTART IDENTITY CASCADE;"
          
          echo "âœ… Table is now empty and ready for the next batch."

      - name: Verify Wipe
        if: success()
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Current row count:"
          psql "$DB_URL" -t -c "SELECT count(*) FROM public.ingredients_recent;"